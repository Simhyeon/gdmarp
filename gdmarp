#!/bin/bash

# Reference source : https://stackoverflow.com/questions/7069682/how-to-get-arguments-with-flags-in-bash

# ----------
# VARIABLES
INPUT=$PWD
OUTPUT=$PWD/build
INCLUDE=""
PRESERVE=false
DEFAULT=true
DOCKER=false
GIT=false
PACKAGE=$(basename $BASH_SOURCE)
PACKAGE_DIR=$(dirname $(readlink -f "$0"))
ACTION=""

# ----------
# FUNCTIONS

function gd_help(){
	echo "$PACKAGE - Compile markdown file into pptx file with predefined macro support."
	echo "Usage: [options] action [arguments]"
	echo " "
	echo "options:"
	echo "-h, --help            show brief help"
	echo "-I, --include=DIR     specify a m4 script directory to include"
	echo "-p, --preserve        preserve middle format"
	echo "--no-default          do not apply default macro rules"
	echo "--docker              indicate docker usage for init or compile. Docker image needs loose privilege to compile."
	echo "--git                 initiate with git after gdmarp init and create gitignore file"
	echo " "
	echo "actions:"
	echo "init                  Initiate file structure"
	echo "compile               compile markdown"
	echo "check                 check installed dependencies"
}

function gd_init(){
	touch $INPUT/index.md  
	mkdir $INPUT/res $INPUT/inc $INPUT/build $INPUT/css $INPUT/m4_ext
	cp $PACKAGE_DIR/env.m4 -f $INPUT/env.m4
	cp $PACKAGE_DIR/index.m4 -f $INPUT/index.m4
	cp $PACKAGE_DIR/default.md -f $INPUT/index.md
	cp $PACKAGE_DIR/css/*.css -f $INPUT/css
	cp $PACKAGE_DIR/m4_ext/* -f $INPUT/m4_ext
	[ "$DOCKER" = "true" ] && chmod 777 $INPUT/build

	[ "$GIT" = "true" ] && cd $INPUT && git init && printf "build\nout.md" > .gitignore
}

function gd_compile(){
	# M4 include path
	[[ -z "$INCLUDE" ]] && INCLUDE=$PWD
	# Scripts array to process
	SCRIPTS=($INPUT/index.m4)
	# If default script is enabled or not disabled
	[[ "$DEFAULT" = "true" ]] && SCRIPTS+=($INPUT/env.m4 $PACKAGE_DIR/m4/default.m4)
	# Preprocessing before marp compilation
	m4 -I $PWD -I $PACKAGE_DIR/m4 -I $INCLUDE "${SCRIPTS[@]}" $INPUT/index.md > $INPUT/out.md

	# Compile with marp-cli
	if [ "$DOCKER" = "false" ]; then
		# No Docker
		mkdir -p $OUTPUT
		marp --allow-local-files --pptx --html $INPUT/out.md -o $OUTPUT/out.pptx
	else
		# With Docker
		mkdir -p $OUTPUT
		docker run --rm --init -v $INPUT:/home/marp/app/ -e LANG=$LANG marpteam/marp-cli out.md --pptx --allow-local-files --html -o build/out.pptx
	fi
	[ "$PRESERVE" = "false" ] && rm $INPUT/out.md
}

function gd_check(){
	# Check binary installation
	# Currently m4 and awk is necessary regardless of docker image
	CLEAN=true
	echo "Checking m4 install..." && [ -z $(command -v m4) ] && echo "M4 not installed" && CLEAN=false
	echo "Checking awk install..." && [ -z $(command -v awk) ] && echo "Awk not installed" && CLEAN=false

	if [ "$DOCKER" = "false" ]; then
		echo "Checking google chrome install..." && [ -z $(command -v google-chrome) ] && echo "Chrome browser not installed or not found in path." && CLEAN=false
		echo "Checking marp install..." && [ -z $(command -v marp) ] && echo "Marp cli not installed" && CLEAN=false
		[ "$CLEAN" == "true" ] && echo "Every dependencies are installed"
	else
		# Check docker installation
		# DOCKER CHECK
		echo "Checking marp-cli docker image installed"
		if [ "$(docker image ls | grep -c marpteam/marp-cli)" = "0" ]; then
			echo "ERR : Docker image is not installed"
			CLEAN=false
		fi
		[ "$CLEAN" == "true" ] && echo "Every dependencies are installed"
	fi
}

function gd_main(){
	# No arg given print -h
	if [ $# -eq 0 ]; then
		gd_help
		exit 0
	fi

	# Argument parse
	while test $# -gt 0; do
		case "$1" in 
			-h|--help)
				ACTION=gd_help
				break
				;;
			-I)
				shift
				if test $# -gt 0; then
					export INCLUDE=$1
				fi
				;;
			--include*)
				export INCLUDE=`echo $1 | sed -e 's/^[^=]*=//g'`
				shift
				;;
			--docker)
				export DOCKER=true
				shift
				;;
			-p|--preserve)
				PRESERVE=true
				shift
				;;
			--no-default)
				DEFAULT=false
				shift
				;;
			--git)
				GIT=true
				shift
				;;
			init)
				ACTION=gd_init
				shift
				;;
			compile)
				ACTION=gd_compile
				shift
				;;
			check)
				ACTION=gd_check
				shift
				;;
			*)
				break
				;;
		esac
	done
	$ACTION
	exit 0
}

# ----------
# MAIN
gd_main $*
